# Cloud Formation テンプレート開発の Tips: Nested Stack 編

## CFn テンプレートの Nested Stack 構成について
---
## **Q. Nested Stack 構成と Outputs による複数 Stack 間を参照する構成のどちらが優れているか：**
## **結論：どちらも良くないので、SSM Parameter Store を利用し、動的参照で疎結合に構成するべき**
- まず、NestedStack構成の場合の下記の問題がある
    - 子テンプレートをS3バケットに事前にアップロードしておく必要がある
    - 強い依存関係が発生する（子スタックを削除した場合、親スタックは更新することはできなくなり、削除するしかなくなる）
    - 子テンプレートのParametersセクションにパラメータを渡す為には、親のParametersセクションでパラメータを渡す必要があるが、その際、親テンプレート内で親のパラメータを!Refで取得して、子テンプレートに渡すという記述が必要で冗長的
        - 例：SampleParamについての記述がRootとChild用に二重で必要になる
            ```
            Parameters:
                SampleParamRoot:
                    Type: String
            Resources:
                ChildStack:
                    Type: AWS::CloudFormation::Stack
                    Properties:
                        TemplateURL: S3ObjectUrl
                        SampleParamChild: !SampleParamRoot
            ```
- 次に、Outputによる複数Stack間の参照構成も次のような問題がある
    - スタック間に強い依存関係が発生するため、Outputしている値を変更することができない
    - そのため、後々運用していく中で、リソースを修正・改善したいという場合に、それが参照されているリソースだと変更ができないことになり、最悪ImportValueしているスタックを削除してから、Outputしているスタックを更新するという対応を取ることになる
    - しかし、そのような対応では、ダウンタイムが発生する点や、ImportValueしているスタックがステートレスなリソース（つまり作り直しても同じものができるような、代替可能なリソース）でないといけない点、また参照構造が深くなるほど、その労力が増加する点など、が問題になる。
## **まとめ**
- スタック間で参照したい値は、SSM Parameter Store に格納し、動的参照をするのが良い（SSM Parameter Store に格納されたパラメータの値は変更でき、そのパラメータを参照しているテンプレート内でバージョン未指定で記述すれば、テンプレートのメンテナンスも不要になる→詳しくは、'CFnテンプレートのParametersセクションについて'を参照）
- そもそも、スタックはなるべく分割すべきでないと考える（巨大になって可読性が落ちるという意見もあるが、個人的には VSCode などの便利なエディターを使えば問題にならないと思うし、スタックが分割されて参照が増える方が見づらいと思う。）
- スタック分割をする際の粒度は、スタックのライフサイクルを元にすると良い（作成削除のタイミングが同じもしくは近いリソース群）
- 開発しているサービス用のインフラリソース一式が、一発（スタック一つのデプロイだけ）で構築されるように一つのテンプレートに全てまとめて記述して運用している企業もけっこうある（もしくは、IAMリソースのみ分割しているケースも多い）

## メモ
- パラメータストア経由で動的参照している状態で、パラメータを更新したり削除したりしたら、それぞれ参照元のリソースはどうなるのか検証する