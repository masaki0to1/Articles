### EKS + Aurora PostgreSQL で作られている RESTful サーバーを無停止で ECS に移行する手順

※データベースは共有される前提
1. 移行先となる、Aurora PostgreSQLに接続された
ECS環境を作成する
    - ECSタスク定義を作成（既存のk8s deployment YAMLを参照し書き換える）
    
        →リスク：同様なスペックのコンテナとなるようにファイルを正しく書き換えないと意図しないエラーや挙動を引き起こす可能性がある
    - ECSサービスを作成　
    
        →リスク：k8sでは、Ingressリソースでインバウンドを記述できるが、ECSでは定義できないので、インバウンドに関するインフラは別途構築する必要がある。
        
        また、クラスター内のコンテナ間通信を行う仕組みがデフォルトでは存在しないため、CloudMap、内部LB、App Meshなどのソリューションを構築する必要がある。
    
        ※その他ECS構築時の各種必要なロールやセキュリティグループ等、細かい設定の説明は割愛
    
2. ECS用のALBを作成し、リクエストしてアプリケーションが正しく動作することを確認する
    - テスト用にRoute53のホストゾーンを作成
    - AレコードでALBのエイリアスレコードを登録
    - テスト用ドメインへのリクエストがECSアプリケーションにトラフィックされ、正しく動作することを確認する

3. Route53で重み付けによる接続先の切り替えを実行する

    - RESTfullなAPIを提供しているドメイン（※あ）のレコードのルーティングポリシーを加重に変更し、よしなに重みを設定する（例：70）
    - "あ"と同じドメインでECS用ALBのエイリアスレコード（※い）を作成し、ルーティングポリシーを加重に変更し、よしなに重みを設定する（例：30）

    - アプリケーションの挙動や、ECSタスクの負荷の変化などを確認・監視して、ECS環境の動作に問題ないことを確認する

    →フェイルバック：もし何か問題があった場合には、"い"のレコードの重みを0にし、ルーティングが全て元々のEKS環境へ向くようにする
    →リスク：TTLが長いと切り替えに時間がかかる可能性がある。その為、移行作業前からTTLを短めに設定しておく

4. トラフィックの向き先をECS環境に完全に移行する
    - Route53で先ほどのレコードの重みの比率をすべてECS用ALBへ寄せる（"あ"の重みを0に、"い"の重みを100にする）

