# MySQLのメジャーアップグレード方法の比較検討

## メジャーアップグレード方法
4方式を比較

|移行方法|工数|ダウンタイム|切り戻し方法|切り戻し時間|切り戻し時のデータ欠損<br>（切り替え後にデータ書き込みがあった場合）|移行前検証|影響度|難易度|
|:-|:-|:-|:-|:-|:-|:-|:-|:-
|置換方式|小|大（３０分以上）|スナップショットによる復元|中（３０分）|あり|不可|大|最小|
|ダンプ＆リストア方式|中|中〜最大（データ量に比例）|旧環境に切り戻し|中〜最大（データ量に比例）|なし|不可|中|中|
|手動レプリケーション方式|大|小（１０分〜３０分）|旧環境に切り戻し|中|なし|可|小|大|
|B/Gデプロイ方式（RDSのマネージドサービス）|小|最小（１分〜５分）|旧環境に切り戻し|中|なし|可|小|小|

## ポイント
- ダウンタイムは最小にしたい
- 不具合時の影響を最小にしたい
- 切り戻しが確実にできるようにしたい

## レプリケーション方式
- 手動レプリケーション方式
    - メリット：
        - どんな構成でも実施可能（B/Gデプロイ機能の制約事項に該当する場合でも実施可能）
    - デメリット：
        - 工数が大きい
        - 難易度がそれなりに大きい
        - ダウンタイムが少ないが最小ではない
        
    - 移行手順：
        1. クラスターパラメータグループのbinlog_formatをMIXEDに更新する
        2. 対象クラスター内でリーダーインスタンスを追加し、ライターに昇格
        3. ライターインスタンスのスナップショットを取得
        4. スナップショットを復元する（設定は全て同じにする）
        5. binlogファイル、binlogポジションを利用した手動レプリケーションを実行（旧環境→新環境）
        6. 新環境のクラスターをアップグレードする
        7. 新環境のクラスターの検証・動作確認する
        8. アプリケーションを停止する
        9. 旧系統のクラスター名（エンドポイント）をメモしておき、別の名前に変更する
        10. 新系統のクラスター名（エンドポイント）をメモしておいた旧系統のクラスター名に変更し、切り替える
        11. アプリケーションを再開する
    - 切り戻し手順：
        - 新系統へのデータの書き込みがない場合：
            1. アプリケーションが稼働している場合、停止する
            2. 新系統のクラスター名（エンドポイント）をメモしておき、別の名前に変更する
            3. 旧系統のクラスター名（エンドポイント）をメモしておいた新系統のクラスター名に変更し、切り替える
            4. アプリケーションを再開する
        - 新系統へのデータの書き込みがある場合
            1. アプリケーションが稼働している場合、停止する
            2. 新系統のクラスター内のライターインスタンスのスナップショットを取得する
            3. スナップショットを復元する（設定は同じにする）
            4. binlogファイル、binlogポジションを利用した手動レプリケーションを実行（新環境→旧環境）
            5. 新系統のクラスター名（エンドポイント）をメモしておき、別の名前に変更する
            6. 旧系統のクラスター名（エンドポイント）をメモしておいた新系統のクラスター名に変更し、切り替える
            7. アプリケーションを再開する



- B/Gデプロイ方式
    - メリット：
        - ダウンタイムが最小
        - 工数が小ない
        - 切替の間、Blue/Green両環境の書き込みがブロックされ、データ損失を防ぐことができる（ブロック時間は１分ほど）
        - 自動でレプリケーションから切り替えまでできる
    - デメリット：
        - 前提条件がある
        - →対象のDBクラスターは満たしていることを確認済み
        - 2.07からのアップグレードの場合、直接3系へアップグレードできないため、2.11以上へマイナーアップグレードしてから、3系へアップグレードする必要がある
        - →それでも手動より工数やダウンタイムが少ない

    - 移行手順：
        1. クラスターパラメータグループのbinlog_formatをMIXEDに更新する
        2. リーダーインスタンスを追加し、ライターに昇格
        3. B/Gデプロイメントの機能を利用し、エンジンをメジャーアップグレードしたGreen環境を作成
        4. Green環境の検証・動作確認する
        5. Blue環境のライターインスタンスのスナップショットを取得する
        6. B/G切り替えを実施する（書き込み停止時間が約１分、読み込み停止時間が数秒発生→読み込み処理については体感できるほどのダウンタイムが出ない）
    - 切り戻し手順：
        - Green環境へのデータの書き込みがない場合：
            1. アプリケーションが稼働している場合、停止する
            2. Blue環境クラスター内で、リーダーインスタンスを追加し、ライターに昇格する or ライターインスタンスを再起動する
                - blue環境は読み取り専用になっているため
                - 再起動よりリーダーインスタンスを追加しライターに昇格する方が時短になる場合がある
            3. Green環境のクラスター名（エンドポイント）をメモしておき、別の名前に変更する
                - B/Gデプロイ方式ではエンドポイントは変わらないため、Green環境のエンドポイント＝元々のエンドポイント
            4. Blue環境のクラスター名（エンドポイント）をメモしておいたGreen環境のクラスター名に変更し、切り替える
            5. アプリケーションを再開する
        - Green環境へのデータの書き込みがある場合：
            1. アプリケーションが稼働している場合、停止する
            2. Green環境クラスター内のライターインスタンスのスナップショットを取得する
            3. スナップショットを復元する（設定は同じにする）
            4. binlogファイル、binlogポジションを利用した手動レプリケーションを実行（新環境→旧環境）
            5. Green環境のクラスター名（エンドポイント）をメモしておき、別の名前に変更する
            6. Blue環境のクラスター名（エンドポイント）をメモしておいたGreen環境のクラスター名に変更し、切り替える
            7. アプリケーションを再開する


