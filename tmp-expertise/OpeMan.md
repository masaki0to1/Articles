# マルチアカウント運用マニュアル

## 新規アカウント環境払い出し手順
--- 
### 1. 新規アカウントを発行する　※作業アカウント：管理アカウント　作業サービス：AWS Organizations
- その際、メールアドレスの入力が求められるが、管理アカウントのメールアドレスのエイリアスを利用する
- アカウントのセットアップが完了すると、メールが届く

    例：＋以降にメンバーアカウント名を記載

        management@sample.com          （管理アカウントのアドレス）
        management+sandbox@sample.com  （sandboxアカウントのアドレス）

### 2. 適切なOUの配下に移動させる or 新規でOUを作成し所属させる
- 基本的に組織として必要なOUとSCPを作成済みであり、既存OUにSCPを適用させてあるため、適切なOU配下に移動させること
    
    例： 本番環境用アカウントは、Prod_OU 配下に配置する

- 新規でOUを作成する場合は、既存OUの配下に置き、適切なSCPが継承され、ガバナンスが正しく効くように注意すること
    
    ※　ただし、基本的にはこれ以上のOUは必要ない認識
### 3. 新規アカウントへログインする為のユーザーやグループ、適切な権限セットを割り当てる　※作業アカウント：管理アカウント　作業サービス：AWS IAM Identity Center 
- IAM Identity Center のマネジメントコンソール上の、マルチアカウント許可＞AWSアカウント画面で、対象アカウントをチェックし「ユーザーまたはグループを割り当て」を押下
- ユーザーとグループの選択（基本的には、グループを選択）し、許可セットを選択後、確認して送信する

- １アカウントに対して1グループに割り当てる許可セットは必ず１つまでとする　※アクセス制御方針.md ファイル内のSSO設計思想の項を参照


### 4. ログイン確認する
- SSO用アクセスポータルから、今回払い出した環境へログインできるか確認する
- 一度ログインして、更新しないとアクセスポータル上で反映されないので注意する

### 5. 必要な権限を追加作成する
- そのアカウント内に閉じたユーザー（外部の協力会社の開発者用のユーザーなど）を作成する必要がある場合は、そのアカウント内のIAM から適切な権限で作成する
- APIとして運用するユーザーが必要な場合も同様
- それ以外では、基本的にIAMユーザーは作成しない　　※アクセス制御方針.md ファイル内のマルチアカウント環境におけるアクセスの一元管理の項を参照
- **そのため、IAM の実行権限をSCPで制限しているので、適宜インフラ管理者へ連携すること**　※SCP設計方針.mdファイルを参照

## 運用に関して
---
- マルチアカウント環境のセキュリティ情報は、auditアカウントに集約しているので、基本的にはそこで監視運用作業を行うこと
- auditアカウントでは、SecurityHubで一元化されたセキュリティ情報や、Config、CloudTrailなどを必要に応じて確認すること
- CloudFormation StackSets で Organizations のRoot配下の全アカウントに、StepFunctions, SecurityHub, GuardDuty を連携したセキュリティアラートをデプロイしてあり、新規カウントを追加すると自動でデプロイされるようになっている->今後も組織的に適用したいStackがあれば、StackSets を実装していくこと
- 日次で全アカウントのAWS料金を取得し、S3バケット（billing-cron-bucket）にcsvファイルを格納するLambda関数（get-daily-cost）を管理アカウントで実装してあるので、必要に応じて確認すること

## 今後の実装方針
---
- SSM SessionManagerの導入により、EC2インスタンスのインバウンドポートを全て閉じて運用したい
- また、SSM上で、リソースの状況なども細かく見れるため、有用である
- SSM AutomationでConfigRuleの自動修復や、パッチの自動適用などを実装したい
- SSM SessionManagerをEventBrige,SNSと連携すれば、ログイン検知をメールなどへ通知できるので、本番環境で導入することを検討するのもあり